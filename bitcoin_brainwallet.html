<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Wallet Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Inline bs58 library
        (function(root, factory) {
            if (typeof define === 'function' && define.amd) {
                define([], factory);
            } else if (typeof exports === 'object') {
                module.exports = factory();
            } else {
                root.bs58 = factory();
            }
        }(this, function() {
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            const ALPHABET_MAP = {};
            let BASE = ALPHABET.length;
            let LEADER = ALPHABET.charAt(0);

            for (let z = 0; z < ALPHABET.length; z++) {
                ALPHABET_MAP[ALPHABET.charAt(z)] = z;
            }

            function encode(source) {
                if (source.length === 0) return '';

                let digits = [0];
                for (let i = 0; i < source.length; i++) {
                    let carry = source[i];
                    for (let j = 0; j < digits.length; ++j) {
                        carry += digits[j] << 8;
                        digits[j] = carry % BASE;
                        carry = (carry / BASE) | 0;
                    }

                    while (carry) {
                        digits.push(carry % BASE);
                        carry = (carry / BASE) | 0;
                    }
                }

                let string = '';

                for (let k = 0; source[k] === 0 && k < source.length - 1; ++k) {
                    string += LEADER;
                }

                for (let q = digits.length - 1; q >= 0; --q) {
                    string += ALPHABET[digits[q]];
                }

                return string;
            }

            return {
                encode: encode
            };
        }));

        // Convert hex string to Uint8Array for browser compatibility
        function hexToUint8Array(hexString) {
            let bytes = [];
            for (let i = 0; i < hexString.length; i += 2) {
                bytes.push(parseInt(hexString.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }

        // Simplified function for debugging
        function generateBrainWalletKey(passphrase) {
            alert("generateBrainWalletKey is running...");

            // Step 1: Generate SHA256 Hash
            const sha256Hash = CryptoJS.SHA256(passphrase).toString(CryptoJS.enc.Hex);
            alert("SHA256 Hash: " + sha256Hash);

            // Step 2: Create Extended Key
            const extendedKey = '80' + sha256Hash;
            alert("Extended Key: " + extendedKey);

            // Step 3: Double SHA256
            const doubleSha256 = CryptoJS.SHA256(CryptoJS.SHA256(CryptoJS.enc.Hex.parse(extendedKey)).toString()).toString();
            alert("Double SHA256: " + doubleSha256);

            // Step 4: Create Checksum
            const checksum = doubleSha256.slice(0, 8);
            alert("Checksum: " + checksum);

            // Step 5: Create Final Key
            const finalKey = extendedKey + checksum;
            alert("Final Key: " + finalKey);

            // Step 6: Encode with bs58 using Uint8Array
            try {
                const finalKeyBytes = hexToUint8Array(finalKey);
                const wifKey = bs58.encode(finalKeyBytes);
                alert("WIF Key: " + wifKey);
                return [sha256Hash, wifKey];
            } catch (e) {
                alert("Error during encoding: " + e.message);
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            alert("handleFormSubmit is running...");
            const passphrase = document.getElementById('passphrase').value;
            const [privateKeyBytes, wifKey] = generateBrainWalletKey(passphrase);
            if (wifKey) {
                document.getElementById('wifKey').textContent = 'Private Key (WIF): ' + wifKey;
            }
        }
    </script>
</head>
<body>
    <h1>Bitcoin Wallet Generator</h1>
    <form onsubmit="handleFormSubmit(event)">
        <label for="passphrase">Enter your passphrase:</label>
        <input type="text" id="passphrase" name="passphrase" required>
        <button type="submit">Generate</button>
    </form>
    <p id="wifKey"></p>
</body>
</html>
